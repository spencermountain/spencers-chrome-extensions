<html>
<head>
	<title>home</title>
	<script src="jquery.js" type="text/javascript"></script> 
	<script src="mustache.js" type="text/javascript"></script>   
	<script src="parseuri.js" type="text/javascript"></script>   
	<script src="history.js" type="text/javascript"></script>   
	<script src="tabs.js" type="text/javascript"></script>  
	<script src="search.js" type="text/javascript"></script>   
	<script src="timer.js" type="text/javascript"></script>   

    <link type="text/css" rel="stylesheet" href="cool.css" /> 
	   <script>
	     
	     
	             //make a timer
        $("#time").everyTime(8000,function(i) {
          $(this).html(i);          
        });
	     
	     
	          //make a url into a saved topic
       function keep(url, title){
           var url="http://thekeep.freebaseapps.com/uri_recon?callback=?&url="+url;     //send url to freebase	    
           $.getJSON(url, function(data) {
              alert(JSON.stringify(data));
              addnew(data);                       
           });
       }
       
	  function renderthings(){	   
               var timeoutID2 = window.setTimeout(      
                    function(){
                              $('div.description').each(function(){
                                  $(this).css('opacity', 0.7);
                                  //..set width same as the image...
                                  
                                  var imgwidth=$(this).siblings('img').width();
                                  if(imgwidth<50){imgwidth=150;}
                                  $(this).css('width', imgwidth);
                                  $(this).parent(".description").css('width', imgwidth);
                                  $(this).parents(".wrapper").css('width', imgwidth);
                                  $(this).css('display', 'block');
                                });
                          
                            $('.wrapper').hover(function(){  
                                 $(this).children('.description').stop().fadeTo(150, 0.9);  
                             },function(){   
                                 $(this).children('.description').stop().fadeTo(150, 0.7);  
                             });            
                         },100);
	   }
	   
	   

       
       //get a better title from the title tag
       function parsetitle(title, url){         
         //remove junk home page titles with domains
         var parsed=parseUri(url);
         if(parsed.directory == '/'){
           return title=parsed.host;
         }
         
         var parts=title.split(/\W[\||\-]\W/);
         if(!parts || parts.length<2){return title;}
         
         if(parts[0].length < parts[parts.length-1].length){
           title=parts[parts.length-1]
         }else{
           title=parts[0];
         }
         if (title.length > 40){
                   var tokens=title.split(' ');
	                  for(var i in tokens){
	                    title+=' '+tokens[i];
	                    if(title.length>40){ 
	                      title+='...';
	                      break
	                      }
	                  }
	               }
         return $.trim(title);
       }
	   
	   
	   function closetab(tabId) {
        try {
          chrome.tabs.remove(tabId, function() {});
        } catch (e) {
          alert(e);
        }
	        location.reload();
      }
	   
	   
	   
	    //remove duplicates from array
 function unique(x) {
   var newArray=new Array();
    label:for(var i=0; i<x.length;i++ ){
      for(var j=0; j<newArray.length;j++ ){ 
          if(newArray[j]==x[i]) 
          continue label;
        }
        newArray[newArray.length] = x[i];
      }
    return newArray;
  }
	          
       
       
       function toggle(sel){
          $('#tabshow').toggle()
       }
           
       //localstorage i/o
        function loadthings() {
	        var data = localStorage["learn"]||'[]';
	        data=JSON.parse(data);	
	        console.log(data)
              $('#keeptemplate').mustache({things:data}).appendTo('#showlist');
              renderthings();     
         }
      
        function addnew(obj) { 
        console.log(obj)
	        var old = localStorage["learn"] || '[]';
	        old=JSON.parse(old);
	        for(var i in old){
	          if(old[i].link==obj.link){console.log(obj.url+'   - exists');return false; }
	        }
	        old.unshift(obj);
	        localStorage["learn"] = JSON.stringify(old);	
	        renderthings();
	        location.reload();
        }


        function erasethings() {
	        localStorage.removeItem("learn");	
	        localStorage["learn"] = JSON.stringify([]);
	        location.reload();
        }
       
       
       renderthings();









//freebase search logic 
       var found={};
       $(document).ready(function(){
       var timeoutID = window.setTimeout(null, 800);
           var el=$("#query");
             $(el).focus();
             el.keyup(function () {
             var found={};
              window.clearTimeout(timeoutID);//for fast typing
              timeoutID = window.setTimeout(function(){
                            
              var text = $(el).val(); 
              var url="http://keep.spencermountain.user.dev.freebaseapps.com/namesearch?callback=?&q="+text;
                 $.getJSON(url, function(data) {
                    var html='<a href="#" class="addlearn">'+data.name
                    +'<img src="http://www.freebase.com/api/trans/image_thumb'+data.id
                    +'?errorid=/m/0djw4wd&maxwidth=200&maxheight=200" / ></a>';
                    
                   $("#result").html('<span>'+html+'</span>');                   
                   found=data;
                   $(".addlearn").click(function(){
                       addnew(found);
                   });
                   
                 });
           
              }, 800);
          });
       });


      // jQuery Mustache Plug-In 
      (function ($) {
          $.fn.mustache = function (data, partial, stream) {
          	if (Mustache && data) {
          	    return $(Mustache.to_html(this.text(), data, partial, stream));
              }
          };
      })(jQuery);
       </script>
       
           <script id="searchtemplate" type="x-tmpl-mustache">    
                  {{name}}  
           </script>
                  
           <script id="keeptemplate" type="x-tmpl-mustache">
              {{#things}}                  
                  <span class='wrapper'>
                    <a href="{{link}}">
                      <img src='{{image}}' / >
                      <div class='description'>
                        <div class='description_content'>&nbsp;{{name}}</div>
                      </div> 
                    </a>     
                 </span>     
              {{/things}}
           </script>
           
          <script id="tabstemplate" type="x-tmpl-mustache">
           <a href="" class ="know" onclick="toggle('#tabstemplate')">tabs:</a>
           <ul id="tabshow">                         
                {{#hasmulti}}
                  close by domain:
                  {{#multi}}
                      <a href="#" onclick="closebulk('{{.}}')">{{.}}</a></br>
                  {{/multi}}
                {{/hasmulti}}
              
                <table>
                    {{#tabs}}
                      <tr>
                        <td>
                          <a href="{{url}}">
                            <img style="width:15px; height:15px;" src="{{favicon}}" / >
                            {{title}}
                          </a> 
                        </td>
                        <td>
                          <a href="#" onClick="closetab( {{id}} );">close</a>            
                        </td>
                        <td>
                          <a href="#" onClick='keep("{{url}}", "{{title}}")'>keep</a>            
                        </td>
                      </tr>   
                    {{/tabs}}
                  </table> 

                {{#hasduplicates}}
                  <a href="#" onclick="closeduplicates()"> close {{duplicates}} duplicates</a>
                {{/hasduplicates}}
              </ul>
           </script>
           
          <script id="historytemplate" type="x-tmpl-mustache">
             <ul id="tabs">
              {{#tabs}}
                <div>
                      <img style="width:15px; height:15px;" src="{{favicon}}" / >
                       <a class="domain" style="font-size:{{font}}">{{domain}}</a>  
                      <br/ >
                      <ul class="sites" id="{{domain}}" style="display:none;">
                        <table style="position:relative; left:100px;">
                          {{#sites}}
                            <tr>
                              <td>
                               <a href="{{url}}">{{title}}</a>
                              </td>
                              <td>
                                <a href="#" onClick='keep("{{url}}", "{{title}}")'>keep</a>
                              </td>
                            </tr>
                          {{/sites}}
                        </table>
                      </ul>
                      </div>
                {{/tabs}}
              </ul>
           </script>
</head>
<body onload="loadthings()">

<div id="total"></div>
<div id="time"></div>

	<div id="showlist">	
	</div>	
	<br />
	<button onclick="erasethings()">yeah, i know</button>	
	<br />	
	
	  <form action="#" onsubmit="addnew(found)">
	    <input id="query" style="height:60; position:relative; color:grey; font-size:32px;" autocomplete="off" value=""/>
      <div id="result"></div>
	  </form>
	  
	  
          
          <div id="tablist"></div>
	
	        <h3>history:</h3>
          <div id="historylist"></div>
	
</body>
</html>
