<html>
<head>
	<title>home</title>
	<script type="text/javascript" src="jquery.js"></script> 
	<script src="mustache.js" type="text/javascript"></script>   
	<script src="parseuri.js" type="text/javascript"></script>   

    <link type="text/css" rel="stylesheet" href="cool.css" /> 
	   <script>
	   
	   
       $(document).ready(function(){
	   //get open tabs
	     chrome.windows.getAll({ populate: true }, function(windowlist) {
	     var tabs=[];
	     for(var i in windowlist){
	       for(var o in windowlist[i].tabs){
	         var title=windowlist[i].tabs[o].title;
	         var url=windowlist[i].tabs[o].url;
	         if(!title.match(/gmail|hotmail/i)){	           
	           if(1||!url.match(/^chrome/)){
	           
	             var parsed=parseUri(url);
	             var favicon=null;
	             if(parsed.host){
	               favicon='http://'+parsed.host+'/favicon.ico';
	             }
	         
	             tabs.push({ url:url, title:title, favicon:favicon, id:windowlist[i].tabs[o].id})	           
	            }
	         }
	         }
	     }
	     console.log(tabs);
       $('#tabstemplate').mustache({tabs:tabs}).appendTo('#tablist');
	     
	     //urls to freebase
	     
         var url="http://keep.spencermountain.user.dev.freebaseapps.com/uri_recon?callback=?&dump="+JSON.stringify(tabs);
         console.log(url);
       /*  $.getJSON(url, function(data) {
         console.log(data);
         for(var i in data){
            var html='<tr><td><a href="#" class="addlearn">'+data[i].name
            +'</td><img src="http://www.freebase.com/api/trans/image_thumb'+data[i].id
            +'?errorid=/m/0djw4wd&maxwidth=200&maxheight=200" / ></tr></a>';
            }
           $("#result").html('<table>'+html+'</table>');                   
           found=data;
           $(".addlearn").click(function(){
               addnew(found);
           });
           
         });*/
	     
	     
	     });
	   })
	   
	   
	   
	   
	   function closetab(tabId) {
        try {
          chrome.tabs.remove(tabId, function() {
            console.log('tab: ' + tabId + ' removed.');
          });
        } catch (e) {
          alert(e);
        }
	        location.reload();
      }
	   
	   
	   
	   
	   
       var found={};
       $(document).ready(function(){//freebase search logic 
       var timeoutID = window.setTimeout(null, 800);
           var el=$("#query");
             $(el).focus();
             el.keyup(function () {
             var found={};
              window.clearTimeout(timeoutID);//for fast typing
              timeoutID = window.setTimeout(function(){
                            
              var text = $(el).val(); 
              var url="http://keep.spencermountain.user.dev.freebaseapps.com/namesearch?callback=?&q="+text;
                 $.getJSON(url, function(data) {
                    var html='<tr><td><a href="#" class="addlearn">'+data.name
                    +'</td><img src="http://www.freebase.com/api/trans/image_thumb'+data.id
                    +'?errorid=/m/0djw4wd&maxwidth=200&maxheight=200" / ></tr></a>';
                    
                   $("#result").html('<table>'+html+'</table>');                   
                   found=data;
                   $(".addlearn").click(function(){
                       addnew(found);
                   });
                   
                 });
           
              }, 800);
          });
       });
       
       
       
              
       //templating
           var template_data = { 
        	  	};
       
       
       
       //localstorage i/o
        function loadthings() {
	        var data = localStorage["learn"]||'[]';
	        data=JSON.parse(data);	
          template_data.freebase=data;

          $(function () {
              $('#template').mustache(template_data).appendTo('#showlist');

               var timeoutID2 = window.setTimeout(      
                    function(){
                              $('div.description').each(function(){
                                  $(this).css('opacity', 0.7);
                                  //..set width same as the image...
                                  
                                  var imgwidth=$(this).siblings('img').width();
                                  if(imgwidth<50){imgwidth=100;}
                                  console.log(imgwidth);
                                  $(this).css('width', imgwidth);
                                  $(this).parent(".description").css('width', imgwidth);
                                  $(this).parents(".wrapper").css('width', imgwidth);
                                  $(this).css('display', 'block');
                                });
                          
                            $('.wrapper').hover(function(){  
                                 $(this).children('.description').stop().fadeTo(150, 0.9);  
                             },function(){   
                                 $(this).children('.description').stop().fadeTo(150, 0.7);  
                             });            
                         },400);
            
                });
      }
      
        function addnew(obj) {
          console.log(obj);          
	        var old = localStorage["learn"] || '[]';
	        old=JSON.parse(old)
	        old.unshift(obj);
	        localStorage["learn"] = JSON.stringify(old);	
	        location.reload();
        }


        function erasethings() {
	        localStorage.removeItem("learn");	
	        localStorage["learn"] = JSON.stringify([]);
	        location.reload();
        }
       



            $('div.description').each(function(){
              $(this).css('opacity', 0.7);
              //..set width same as the image...
              
              var imgwidth=$(this).siblings('img').width();
              if(imgwidth<50){imgwidth=100;}
              console.log(imgwidth);
              $(this).css('width', imgwidth);
              $(this).parent(".description").css('width', imgwidth);
              $(this).parents(".wrapper").css('width', imgwidth);
              $(this).css('display', 'block');
            });
            
              $('.wrapper').hover(function(){  
                   $(this).children('.description').stop().fadeTo(150, 0.9);  
               },function(){   
                   $(this).children('.description').stop().fadeTo(150, 0.7);  
               }); 



// jQuery Mustache Plug-In 
(function ($) {
    $.fn.mustache = function (data, partial, stream) {
    	if (Mustache && data) {
    	    return $(Mustache.to_html(this.text(), data, partial, stream));
        }
    };
})(jQuery);
       </script>
       
           <script id="template" type="x-tmpl-mustache">
            {{#freebase}}                  
                <span class='wrapper'>
                  <a href="http://freebase.com/view{{id}}">
                  <img src='http://freebase.com/api/trans/image_thumb{{id}}?maxwidth=200&maxheight=200&errorid=/m/0djw4wd' / >
                  <div class='description'>
                    <div class='description_content'>{{name}}</div>
                  </div> 
                </a>     
               </span>     
            {{/freebase}}
           </script>
           
          <script id="tabstemplate" type="x-tmpl-mustache">
            {{#tabs}}
              <a href="{{url}}">
              <img style="width:15px; height:15px;" src="{{favicon}}" / >
              {{title}}
              </a>  -<a href="#" onClick="closetab({{id}})">close</a>            
              <br />   
            {{/tabs}}
           </script>
</head>
<body onload="loadthings()">

<div id="total"></div>

  <form action="#" onsubmit="addnew(found)">
	  <input id="query" value=""/>
    <div id="result"></div>
	</form>
	<div id="showlist">
	
	</div>	
	<br />
	<button onclick="erasethings()">i know this all</button>	
	<button onclick="gettabs()">tabdump</button>
	
	<br />	
	<div id="tablist">
	
</body>
</html>
